---
config:
  theme: default
---

flowchart TD
    A["Start"] --> Img["Image"]
    Img --> Pre["Preprocess"] & Ann["Annotation"]
    Pre --> PreOut["Preprocessed Image"]
    Ann --> MaskAnn["Annotate Masked Image"]
    MaskAnn --> Tile["Create Tile Index (256x256)"]
    PreOut --> Tile
    Tile --> Pair["Pair Tiled Images"]
    Pair -->|If annotation exists| Aug["Augment Tiled Images"]
    Pair -->|If not| XGB["Model: XGBoost"]

    Aug --> Datasets["Train/Test Datasets"]
    Datasets --> TrainXGB["Train XGBoost"] & TrainUNet["Train U-Net"]
    TrainXGB --> Models["Store Models"]
    TrainUNet --> Models
    Models --> XGB & UNet["Model: U-Net"] & Transf["Model: Transformer"]
    
    XGB --> Pred["Predict Class (0/1)"]
    Pred --> Decision["Class == 1?"]
    Decision -->|Yes| UNet
    Decision -->|No| DB["Tile Index DB"]
    
    UNet --> MaskOut["Segment Mask + IoU"]
    MaskOut --> IoUCheck{"IoU ≥ 0.85?"}
    IoUCheck -->|Yes| Vec["Vectorize Mask"]
    IoUCheck -->|No| DB

    Vec --> GIS["Update GIS Layer"]
    GIS --> End1["End"]
    
    DB --> Disk["Disk Storage"]
    Disk --> TransMask["Sequence Mask Images"]
    TransMask --> Transf
    Transf --> RMSE["Evaluate RMSE"]
    RMSE --> RMSECheck{"RMSE > 0.3?"}
    RMSECheck -->|Yes| TrainTrans["Update Transformer"]
    RMSECheck -->|No| Vec2["Vectorize Mask"]
    TrainTrans --> Models
    Vec2 --> GIS2["Update GIS Layer"]
    GIS2 --> End2["End"]
    
    style A stroke:#333,stroke-width:2px
    style End1 stroke:#2ecc71,stroke-width:2px
    style End2 stroke:#2ecc71,stroke-width:2px

    %% Специальные формы
    A@{ shape: terminal }
    End1@{ shape: terminal }
    End2@{ shape: terminal }
    Decision@{ shape: decision }
    IoUCheck@{ shape: diam }
    RMSECheck@{ shape: diam }
    DB@{ shape: db }
    Disk@{ shape: disk }
    GIS@{ shape: in-out }
    GIS2@{ shape: in-out }